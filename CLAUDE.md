# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Email PII De-Identification Annotation Platform — a web app for annotating Personally Identifiable Information (PII) in email (.eml) files with role-based workflows for Admins, Annotators, and QA reviewers.

## Repository Layout

- `frontend/` — React 19 + TypeScript 5.9 + Vite 7 + Tailwind CSS 4 + shadcn/ui
- `backend/` — Django 5.2 + DRF + PostgreSQL
- `docs/` — Requirements (`app-requirement.md`), implementation plan (`impl-plan.md`), module specs (`modules/`), UI wireframes (`ui/`)

## Development Commands

### Frontend (`frontend/`)
```bash
npm run dev          # Vite dev server on http://localhost:5173
npm run build        # tsc -b && vite build
npm run lint         # ESLint
npm run preview      # Preview production build
npx shadcn@latest add <name>  # Install new shadcn/ui component
```

### Backend (`backend/`)
```bash
# Uses uv for dependency management
python manage.py runserver     # Dev server on http://localhost:8000
python manage.py makemigrations
python manage.py migrate
python manage.py check
python manage.py createsuperuser
```

### Database
PostgreSQL — db: `email_annotation`, user: `ganesh`, host: `localhost:5432`

## Critical Constraints

### TypeScript 5.9 — No `enum` keyword
`erasableSyntaxOnly` is enabled. Use const objects + type extraction:
```typescript
export const UserRole = { ADMIN: "ADMIN", ANNOTATOR: "ANNOTATOR", QA: "QA" } as const;
export type UserRole = (typeof UserRole)[keyof typeof UserRole];
```

### Tailwind CSS 4
Uses `@tailwindcss/vite` plugin. There is no `tailwind.config.ts` or `postcss.config.js` — all config is via `@theme` in `src/index.css`.

### TanStack Router — Plugin order matters
In `vite.config.ts`, `TanStackRouterVite()` **must** come before `react()` in the plugins array. Route tree (`src/app/routeTree.gen.ts`) is auto-generated — never edit it manually.

### First-time build
Route tree is generated by Vite, so on a fresh clone: `npx vite build` must succeed before `tsc` will pass. `npm run build` handles this order automatically.

## Architecture

### Frontend (`frontend/src/`)

**Routing**: TanStack Router with file-based routes in `src/app/routes/`. Dynamic segments use `$param` syntax (e.g., `datasets/$id.tsx`). Layout routes use `route.tsx` files with `<Outlet />`. Auth guards use `beforeLoad` hooks on route definitions.

**Three role-based layouts**: AdminLayout (sidebar nav), AnnotatorLayout (top nav), QALayout (top nav) — in `src/components/layouts/`.

**Feature modules** (`src/features/{name}/`): Each contains `api/` (fetcher functions + React Query hooks) and `components/`. Features are self-contained.

**API client** (`src/lib/api-client.ts`): Axios instance, base URL `/api`, reads CSRF token from cookie and attaches as `X-CSRFToken` header. Redirects to `/login` on 401. Vite proxies `/api` to `http://localhost:8000`.

**State management**: Server state via TanStack React Query (60s stale time, 1 retry). Auth state via React Context (`src/lib/auth.tsx`).

**Types** (`src/types/`): `enums.ts` has const enum objects (UserRole, JobStatus, etc.), `models.ts` has TypeScript interfaces for all backend models.

**UI components** (`src/components/ui/`): 26 shadcn/ui components (style: "new-york", base color: neutral).

### Backend (`backend/`)

**Django apps**: `accounts` (User model + auth), `datasets` (Dataset + Job), `core` (AnnotationClass + PlatformSetting + permissions), `annotations` (AnnotationVersion + Annotation + DraftAnnotation), `qa` (QAReviewVersion), `exports` (ExportRecord).

**Custom User model** (`accounts.User`): UUID PK, email-based auth (`USERNAME_FIELD = "email"`), role field (ADMIN/ANNOTATOR/QA), status field (ACTIVE/INACTIVE).

**All models use UUID primary keys**, not auto-incrementing integers.

**Authentication**: Session-based (Django sessions + DRF SessionAuthentication). CSRF protection enabled. No JWT.

**RBAC permissions** (`core/permissions.py`): `IsAdmin`, `IsAnnotator`, `IsQA`, `IsAdminOrAnnotator`, `IsAdminOrQA`, `IsAnyRole`.

**API URL structure**:
- `/api/auth/` — login, logout, me, change-password, forgot-password, reset-password
- `/api/users/` — UserViewSet (DRF router)
- `/api/annotation-classes/` — AnnotationClassViewSet (DRF router)

**DRF pagination**: `PageNumberPagination` with `PAGE_SIZE = 20`.

**Soft deletes**: AnnotationClass uses `is_deleted` flag, not hard delete.

**CORS**: Allows `http://localhost:5173` with credentials.
