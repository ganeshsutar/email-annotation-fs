# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Email PII De-Identification Annotation Platform — a web app for annotating Personally Identifiable Information (PII) in email (.eml) files with role-based workflows for Admins, Annotators, and QA reviewers.

## Repository Layout

- `frontend/` — React 19 + TypeScript 5.9 + Vite 7 + Tailwind CSS 4 + shadcn/ui
- `backend/` — Django 5.2 + DRF + PostgreSQL
- `docs/` — Requirements (`app-requirement.md`), implementation plan (`impl-plan.md`), module specs (`modules/`), UI wireframes (`ui/`)

## Development Commands

### Frontend (`frontend/`)
```bash
npm run dev          # Vite dev server on http://localhost:5173
npm run build        # tsc -b && vite build
npm run lint         # ESLint
npm run preview      # Preview production build
npx shadcn@latest add <name>  # Install new shadcn/ui component
```

### Backend (`backend/`)
```bash
# Uses uv — ALL commands must use "uv run" prefix
uv run python manage.py runserver     # Dev server on http://localhost:8000
uv run python manage.py makemigrations
uv run python manage.py migrate
uv run python manage.py check
uv run python manage.py createsuperuser
```

### E2E Tests (`frontend/`)
```bash
npm run e2e          # Run Playwright tests (headless)
npm run e2e:headed   # Run with visible browser
npm run e2e:ui       # Interactive Playwright UI
npm run e2e:report   # Open HTML test report
```
Both dev servers (Vite + Django) must be running before executing e2e tests. Test credentials live in `frontend/e2e/config.ts` (gitignored); copy from `e2e/config.example.ts`.

### Database
PostgreSQL — db: `email_annotation`, user: `ganesh`, host: `localhost:5432`

## Critical Constraints

### TypeScript 5.9 — No `enum` keyword
`erasableSyntaxOnly` is enabled. Use const objects + type extraction:
```typescript
export const UserRole = { ADMIN: "ADMIN", ANNOTATOR: "ANNOTATOR", QA: "QA" } as const;
export type UserRole = (typeof UserRole)[keyof typeof UserRole];
```

### Tailwind CSS 4
Uses `@tailwindcss/vite` plugin. There is no `tailwind.config.ts` or `postcss.config.js` — all config is via `@theme` in `src/index.css`.

### TanStack Router — Plugin order matters
In `vite.config.ts`, `TanStackRouterVite()` **must** come before `react()` in the plugins array. Route tree (`src/app/routeTree.gen.ts`) is auto-generated — never edit it manually.

### First-time build
Route tree is generated by Vite, so on a fresh clone: `npx vite build` must succeed before `tsc` will pass. `npm run build` handles this order automatically.

### Annotation offset handling
Email content has `\r\n` but the browser DOM normalizes to `\n`. The frontend strips `\r` from `normalizedContent` for accurate `getSelectionOffsets()`. Annotation tag badges are rendered via CSS `::after` with `data-annotation-badge` attr (not inline text) to avoid inflating text offsets. The backend export uses `to_original_offset()` to map stripped offsets back to CRLF positions.

### Sonner toast system
`frontend/src/components/ui/sonner.tsx` must import `useTheme` from `@/lib/theme` (custom), **not** from `next-themes`. The custom `useTheme` exposes `resolvedMode` for the Toaster's `theme` prop.

## Architecture

### Frontend (`frontend/src/`)

**Routing**: TanStack Router with file-based routes in `src/app/routes/`. Dynamic segments use `$param` syntax (e.g., `datasets/$id.tsx`). Layout routes use `route.tsx` files with `<Outlet />`. Auth guards use `beforeLoad` hooks on route definitions. Route `to` props are type-checked against actual registered routes.

**Three role-based layouts**: AdminLayout (sidebar nav), AnnotatorLayout (top nav), QALayout (top nav) — in `src/components/layouts/`.

**Provider hierarchy** (`src/app/provider.tsx`): ErrorBoundary → ThemeProvider → QueryClientProvider → AuthProvider → Toaster (sonner).

**Feature modules** (`src/features/{name}/`): Each contains `api/` (fetcher functions + React Query hooks), optional `hooks/`, and `components/`. 10 features: annotation-classes, annotations, auth, dashboard, datasets, export, job-assignment, qa-review, users, version-history.

**API client** (`src/lib/api-client.ts`): Axios instance, base URL `/api`, reads CSRF token from cookie and attaches as `X-CSRFToken` header. Error interceptor toasts on 403/409/500+/network errors and redirects to `/login` on 401. Vite proxies `/api` to `http://localhost:8000`.

**State management**: Server state via TanStack React Query (60s stale time, 1 retry, refetchOnWindowFocus disabled). Global mutation `onError` fallback toasts the API error. Auth state via React Context (`src/lib/auth.tsx`).

**Theme system** (`src/lib/theme.tsx`): Custom ThemeProvider using OKLCH color space with neutral/base color presets and radius options. Persists to localStorage, applies CSS custom properties. Does **not** use `next-themes` at runtime.

**Types** (`src/types/`): `enums.ts` has const enum objects (UserRole, JobStatus, DatasetStatus, AnnotationSource, QADecision, etc.), `models.ts` has TypeScript interfaces for all backend models.

**UI components** (`src/components/ui/`): 30+ shadcn/ui components (style: "new-york", base color: neutral). Shared components in `src/components/` include TableSkeleton, EmptyState, StatusBadge, RawContentViewer, EmailViewer, ClassSelectionPopup, SameValueLinkingDialog.

**E2E testing** (`e2e/`): Playwright with Chromium. Uses `data-testid` attributes for element selection. Fixtures in `e2e/fixtures/auth.ts` export `loginViaUI()`, `getCredentials()`, and `TestRole`/`ROLE_DASHBOARDS` constants. Separate `tsconfig.e2e.json` keeps e2e code out of the app build.

### Backend (`backend/`)

**8 Django apps**: `accounts` (User model + auth), `datasets` (Dataset + Job), `core` (AnnotationClass + PlatformSetting + permissions), `annotations` (AnnotationVersion + Annotation + DraftAnnotation), `qa` (QAReviewVersion + QADraftReview), `exports` (ExportRecord + deidentification), `history` (version history views, no models), `dashboard` (stats + performance views, no models).

**Custom User model** (`accounts.User`): UUID PK, email-based auth (`USERNAME_FIELD = "email"`), role field (ADMIN/ANNOTATOR/QA), status field (ACTIVE/INACTIVE).

**All models use UUID primary keys**, not auto-incrementing integers.

**Authentication**: Session-based (Django sessions + DRF SessionAuthentication). CSRF protection enabled. No JWT.

**RBAC permissions** (`core/permissions.py`): `IsAdmin`, `IsAnnotator`, `IsQA`, `IsAdminOrAnnotator`, `IsAdminOrQA`, `IsAnyRole`.

**Job status lifecycle**: UPLOADED → ASSIGNED_ANNOTATOR → ANNOTATION_IN_PROGRESS → SUBMITTED_FOR_QA → ASSIGNED_QA → QA_IN_PROGRESS → QA_ACCEPTED/QA_REJECTED → DELIVERED. Status transitions use **optimistic locking** via `expected_status` field (returns 409 Conflict on mismatch).

**API URL structure**:
- `/api/auth/` — login, logout, me, change-password, forgot-password, reset-password
- `/api/users/` — UserViewSet (DRF router)
- `/api/annotation-classes/` — AnnotationClassViewSet (DRF router)
- `/api/datasets/` — DatasetViewSet (DRF router)
- `/api/jobs/` — JobViewSet (DRF router)
- `/api/annotations/` — AnnotationViewSet (raw_content, my_jobs, start, save_draft, submit)
- `/api/qa/` — QAReviewViewSet (similar lifecycle to annotations)
- `/api/history/` — VersionHistoryViewSet
- `/api/exports/` — ExportViewSet (deidentify + zip download, StreamingHttpResponse for >1MB)
- `/api/dashboard/` — DashboardViewSet (stats, job_status_counts, recent_datasets, performance)
- `/api/settings/` — PlatformSetting (blind review toggle, min annotation length)
- `/api/health/` — health check

**DRF pagination**: `PageNumberPagination` with `PAGE_SIZE = 20`.

**Soft deletes**: AnnotationClass uses `is_deleted` flag, not hard delete.

**CORS**: Allows `http://localhost:5173` with credentials.
